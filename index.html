<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCharacters - Character.AI Alternative</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
        }

        .sidebar {
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: #333;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .controls {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-group {
            margin-bottom: 16px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .control-group input,
        .control-group select,
        .control-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-group input:focus,
        .control-group select:focus,
        .control-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .characters-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .character-item {
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .character-item:hover,
        .character-item.active {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
            transform: translateX(5px);
        }

        .character-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .character-description {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #333;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            margin: 20px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chat-header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            color: #333;
            font-size: 20px;
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            max-width: 70%;
            padding: 16px 20px;
            border-radius: 18px;
            word-wrap: break-word;
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: #667eea;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 6px;
        }

        .message.assistant {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 6px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .message.typing {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 6px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: typingAnimation 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .chat-input {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-container textarea {
            flex: 1;
            padding: 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            resize: none;
            font-size: 14px;
            font-family: inherit;
            max-height: 120px;
            min-height: 48px;
            transition: all 0.3s ease;
        }

        .input-container textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-btn {
            padding: 16px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .send-btn:hover:not(:disabled) {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h3 {
            color: #333;
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 4px;
        }

        .close-btn:hover {
            color: #333;
        }

        .tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid #e1e5e9;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .character-preview {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-top: 16px;
            border: 2px dashed #e1e5e9;
        }

        .character-preview h4 {
            color: #333;
            margin-bottom: 12px;
        }

        .character-preview p {
            color: #666;
            line-height: 1.6;
        }

        .share-link {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 8px 0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .service-status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .service-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .service-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
            }
            
            .main-chat {
                margin: 10px;
                margin-top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="header">
            <h1>OpenCharacters</h1>
            <p>Character.AI Alternative</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="service-select">AI Service:</label>
                <select id="service-select">
                    <option value="groq">Groq (Kimi)</option>
                    <option value="openai">OpenAI (GPT-4)</option>
                    <option value="anthropic">Anthropic (Claude)</option>
                    <option value="huggingface">Hugging Face</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="api-key">API Key:</label>
                <input type="password" id="api-key" placeholder="Enter your API key">
            </div>
            
            <button class="btn btn-primary" onclick="testConnection()">Test Connection</button>
            <div id="connection-status"></div>
        </div>
        
        <div class="characters-list" id="characters-list">
            <!-- Characters will be populated here -->
        </div>
        
        <div style="padding: 20px; border-top: 1px solid rgba(255, 255, 255, 0.2);">
            <button class="btn btn-primary" onclick="openCharacterModal()">New Character</button>
        </div>
    </div>

    <div class="main-chat">
        <div class="chat-header">
            <div>
                <h2 id="current-character-name">Select a character to start chatting</h2>
                <p id="current-character-description" style="color: #666; font-size: 14px;"></p>
            </div>
            <div>
                <button class="btn btn-secondary" onclick="clearChat()" style="margin-right: 10px;">Clear Chat</button>
                <button class="btn btn-secondary" onclick="exportChat()">Export</button>
            </div>
        </div>

        <div class="chat-messages" id="chat-messages">
            <div style="text-align: center; color: #666; margin-top: 50px;">
                <h3>Welcome to OpenCharacters!</h3>
                <p>Select a character from the sidebar or create a new one to start chatting.</p>
            </div>
        </div>

        <div class="chat-input">
            <div class="input-container">
                <textarea id="message-input" placeholder="Type your message..." rows="1" disabled></textarea>
                <button class="send-btn" id="send-btn" onclick="sendMessage()" disabled>
                    Send
                </button>
            </div>
        </div>
    </div>

    <!-- Character Creation/Editing Modal -->
    <div class="modal" id="character-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Create New Character</h3>
                <button class="close-btn" onclick="closeCharacterModal()">&times;</button>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('basic')">Basic Info</button>
                <button class="tab" onclick="switchTab('prompt')">Character Prompt</button>
                <button class="tab" onclick="switchTab('settings')">Settings</button>
            </div>
            
            <div class="tab-content active" id="basic-tab">
                <div class="form-group">
                    <label for="character-name-input">Character Name:</label>
                    <input type="text" id="character-name-input" placeholder="Enter character name">
                </div>
                
                <div class="form-group">
                    <label for="character-description-input">Description:</label>
                    <textarea id="character-description-input" placeholder="Brief description of the character"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="character-avatar-input">Avatar URL (optional):</label>
                    <input type="url" id="character-avatar-input" placeholder="https://example.com/avatar.jpg">
                </div>
            </div>
            
            <div class="tab-content" id="prompt-tab">
                <div class="form-group">
                    <label for="character-prompt-input">Character Prompt:</label>
                    <textarea id="character-prompt-input" placeholder="Define the character's personality, behavior, and speaking style..." rows="10"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="first-message-input">First Message (optional):</label>
                    <textarea id="first-message-input" placeholder="What should the character say when the conversation starts?"></textarea>
                </div>
            </div>
            
            <div class="tab-content" id="settings-tab">
                <div class="form-group">
                    <label for="temperature-input">Creativity (Temperature):</label>
                    <input type="range" id="temperature-input" min="0" max="2" step="0.1" value="0.7">
                    <span id="temperature-value">0.7</span>
                </div>
                
                <div class="form-group">
                    <label for="max-tokens-input">Max Response Length:</label>
                    <select id="max-tokens-input">
                        <option value="100">Short (100 tokens)</option>
                        <option value="300">Medium (300 tokens)</option>
                        <option value="500" selected>Long (500 tokens)</option>
                        <option value="1000">Very Long (1000 tokens)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="system-prompt-input">System Prompt (Advanced):</label>
                    <textarea id="system-prompt-input" placeholder="Additional system instructions for the AI..." rows="5"></textarea>
                </div>
            </div>
            
            <div class="character-preview">
                <h4>Character Preview:</h4>
                <p><strong>Name:</strong> <span id="preview-name">Not set</span></p>
                <p><strong>Description:</strong> <span id="preview-description">Not set</span></p>
                <p><strong>Prompt:</strong> <span id="preview-prompt">Not set</span></p>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-success" onclick="saveCharacter()">Save Character</button>
                <button class="btn btn-secondary" onclick="shareCharacter()">Share Character</button>
                <button class="btn btn-secondary" onclick="closeCharacterModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Global state management
        let characters = [];
        let currentCharacter = null;
        let chatHistory = [];
        let editingCharacterId = null;
        let isTyping = false;
        let isProcessing = false;

        // AI Service configurations
        const AI_SERVICES = {
            groq: {
                name: 'Groq',
                baseUrl: 'https://api.groq.com/openai/v1',
                models: {
                    'moonshotai/kimi-k2-instruct-0905': 'Kimi K2 Instruct',
                    'meta-llama/llama-3.1-8b-instant': 'Llama 3.1 8B',
                    'meta-llama/llama-3.1-70b-versatile': 'Llama 3.1 70B',
                    'mixtral-8x7b-32768': 'Mixtral 8x7B'
                },
                defaultModel: 'moonshotai/kimi-k2-instruct-0905'
            },
            openai: {
                name: 'OpenAI',
                baseUrl: 'https://api.openai.com/v1',
                models: {
                    'gpt-4': 'GPT-4',
                    'gpt-4-turbo': 'GPT-4 Turbo',
                    'gpt-3.5-turbo': 'GPT-3.5 Turbo'
                },
                defaultModel: 'gpt-3.5-turbo'
            },
            anthropic: {
                name: 'Anthropic',
                baseUrl: 'https://api.anthropic.com/v1',
                models: {
                    'claude-3-opus-20240229': 'Claude 3 Opus',
                    'claude-3-sonnet-20240229': 'Claude 3 Sonnet',
                    'claude-3-haiku-20240307': 'Claude 3 Haiku'
                },
                defaultModel: 'claude-3-haiku-20240307'
            },
            huggingface: {
                name: 'Hugging Face',
                baseUrl: 'https://api-inference.huggingface.co/models',
                models: {
                    'microsoft/DialoGPT-large': 'DialoGPT Large',
                    'microsoft/DialoGPT-medium': 'DialoGPT Medium',
                    'facebook/blenderbot-400M-distill': 'BlenderBot 400M'
                },
                defaultModel: 'microsoft/DialoGPT-medium'
            }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadCharacters();
            setupEventListeners();
            loadAPIKeys();
            updateCharacterList();
            
            // Check for shared character in URL
            const urlParams = new URLSearchParams(window.location.search);
            const sharedChar = urlParams.get('char');
            if (sharedChar) {
                try {
                    const character = JSON.parse(decodeURIComponent(sharedChar));
                    if (character && character.name && character.prompt) {
                        characters.push(character);
                        saveCharacters();
                        updateCharacterList();
                        selectCharacter(characters.length - 1);
                    }
                } catch (e) {
                    console.error('Error parsing shared character:', e);
                }
            }
        });

        // Event listeners setup
        function setupEventListeners() {
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            messageInput.addEventListener('input', function() {
                sendBtn.disabled = !this.value.trim() || !currentCharacter || isProcessing;
            });
            
            // Update temperature display
            document.getElementById('temperature-input').addEventListener('input', function() {
                document.getElementById('temperature-value').textContent = this.value;
                updateCharacterPreview();
            });
            
            // Update character preview on input changes
            ['character-name-input', 'character-description-input', 'character-prompt-input', 'first-message-input', 'system-prompt-input'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateCharacterPreview);
            });
        }

        // Character management functions
        function loadCharacters() {
            const saved = localStorage.getItem('opencharacters-characters');
            if (saved) {
                try {
                    characters = JSON.parse(saved);
                    // Add default characters if none exist
                    if (characters.length === 0) {
                        addDefaultCharacters();
                    }
                } catch (e) {
                    console.error('Error loading characters:', e);
                    characters = [];
                    addDefaultCharacters();
                }
            } else {
                addDefaultCharacters();
            }
        }

        function saveCharacters() {
            localStorage.setItem('opencharacters-characters', JSON.stringify(characters));
        }

        function addDefaultCharacters() {
            const defaultCharacters = [
                {
                    id: Date.now() + 1,
                    name: "Game Master",
                    description: "A wise and creative game master for roleplaying adventures",
                    prompt: "You are an experienced and creative game master. You create immersive roleplaying experiences with rich descriptions, engaging NPCs, and exciting plot twists. You're knowledgeable about various genres including fantasy, sci-fi, mystery, and horror. Always encourage player creativity and adapt the story based on their actions.",
                    firstMessage: "Welcome to our adventure! What kind of world would you like to explore today?",
                    settings: {
                        temperature: 0.8,
                        maxTokens: 500,
                        systemPrompt: "You are an expert game master creating engaging tabletop RPG experiences."
                    },
                    avatar: ""
                },
                {
                    id: Date.now() + 2,
                    name: "Therapist",
                    description: "A caring and professional therapist for emotional support",
                    prompt: "You are a compassionate and professional therapist. You listen carefully, ask thoughtful questions, and provide supportive guidance. You help people explore their feelings, develop coping strategies, and gain insights into their behavior. You maintain appropriate boundaries while being warm and understanding.",
                    firstMessage: "Hello, I'm here to listen and support you. How are you feeling today?",
                    settings: {
                        temperature: 0.6,
                        maxTokens: 300,
                        systemPrompt: "You are a licensed therapist providing emotional support and guidance."
                    },
                    avatar: ""
                },
                {
                    id: Date.now() + 3,
                    name: "Creative Writing Partner",
                    description: "An imaginative writing assistant for stories and creative projects",
                    prompt: "You are a talented creative writing partner who loves storytelling in all its forms. You help develop characters, plot outlines, dialogue, and world-building. You're knowledgeable about various genres and writing techniques. You provide constructive feedback and inspire creativity while respecting the author's vision.",
                    firstMessage: "I'm excited to help you create something amazing! What story or creative project would you like to work on?",
                    settings: {
                        temperature: 0.9,
                        maxTokens: 400,
                        systemPrompt: "You are a creative writing expert helping to develop compelling stories and narratives."
                    },
                    avatar: ""
                }
            ];
            
            characters = defaultCharacters;
            saveCharacters();
        }

        function updateCharacterList() {
            const charactersList = document.getElementById('characters-list');
            charactersList.innerHTML = '';
            
            characters.forEach((character, index) => {
                const characterItem = document.createElement('div');
                characterItem.className = 'character-item';
                if (currentCharacter && currentCharacter.id === character.id) {
                    characterItem.classList.add('active');
                }
                
                characterItem.innerHTML = `
                    <div class="character-name">${character.name}</div>
                    <div class="character-description">${character.description || 'No description'}</div>
                `;
                
                characterItem.onclick = () => selectCharacter(index);
                
                // Add context menu for editing
                characterItem.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    editCharacter(index);
                });
                
                charactersList.appendChild(characterItem);
            });
        }

        function selectCharacter(index) {
            currentCharacter = characters[index];
            chatHistory = [];
            
            document.getElementById('current-character-name').textContent = currentCharacter.name;
            document.getElementById('current-character-description').textContent = currentCharacter.description || '';
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
            
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            
            // Show first message if available
            if (currentCharacter.firstMessage) {
                addMessage('assistant', currentCharacter.firstMessage);
            } else {
                addMessage('assistant', `Hello! I'm ${currentCharacter.name}. ${currentCharacter.description || 'How can I help you today?'}`);
            }
            
            updateCharacterList();
        }

        function openCharacterModal(characterId = null) {
            editingCharacterId = characterId;
            const modal = document.getElementById('character-modal');
            const title = document.getElementById('modal-title');
            
            if (characterId !== null) {
                // Edit existing character
                title.textContent = 'Edit Character';
                const character = characters[characterId];
                populateCharacterForm(character);
            } else {
                // Create new character
                title.textContent = 'Create New Character';
                clearCharacterForm();
            }
            
            modal.style.display = 'block';
            updateCharacterPreview();
        }

        function closeCharacterModal() {
            document.getElementById('character-modal').style.display = 'none';
            editingCharacterId = null;
            clearCharacterForm();
        }

        function populateCharacterForm(character) {
            document.getElementById('character-name-input').value = character.name || '';
            document.getElementById('character-description-input').value = character.description || '';
            document.getElementById('character-avatar-input').value = character.avatar || '';
            document.getElementById('character-prompt-input').value = character.prompt || '';
            document.getElementById('first-message-input').value = character.firstMessage || '';
            document.getElementById('temperature-input').value = character.settings?.temperature || 0.7;
            document.getElementById('temperature-value').textContent = character.settings?.temperature || 0.7;
            document.getElementById('max-tokens-input').value = character.settings?.maxTokens || 500;
            document.getElementById('system-prompt-input').value = character.settings?.systemPrompt || '';
        }

        function clearCharacterForm() {
            document.getElementById('character-name-input').value = '';
            document.getElementById('character-description-input').value = '';
            document.getElementById('character-avatar-input').value = '';
            document.getElementById('character-prompt-input').value = '';
            document.getElementById('first-message-input').value = '';
            document.getElementById('temperature-input').value = 0.7;
            document.getElementById('temperature-value').textContent = 0.7;
            document.getElementById('max-tokens-input').value = 500;
            document.getElementById('system-prompt-input').value = '';
            updateCharacterPreview();
        }

        function updateCharacterPreview() {
            const name = document.getElementById('character-name-input').value || 'Not set';
            const description = document.getElementById('character-description-input').value || 'Not set';
            const prompt = document.getElementById('character-prompt-input').value || 'Not set';
            
            document.getElementById('preview-name').textContent = name;
            document.getElementById('preview-description').textContent = description;
            document.getElementById('preview-prompt').textContent = prompt.substring(0, 100) + (prompt.length > 100 ? '...' : '');
        }

        function saveCharacter() {
            const name = document.getElementById('character-name-input').value.trim();
            const prompt = document.getElementById('character-prompt-input').value.trim();
            
            if (!name) {
                alert('Please enter a character name.');
                return;
            }
            
            if (!prompt) {
                alert('Please enter a character prompt.');
                return;
            }
            
            const character = {
                id: editingCharacterId !== null ? characters[editingCharacterId].id : Date.now(),
                name: name,
                description: document.getElementById('character-description-input').value.trim(),
                prompt: prompt,
                firstMessage: document.getElementById('first-message-input').value.trim(),
                settings: {
                    temperature: parseFloat(document.getElementById('temperature-input').value),
                    maxTokens: parseInt(document.getElementById('max-tokens-input').value),
                    systemPrompt: document.getElementById('system-prompt-input').value.trim()
                },
                avatar: document.getElementById('character-avatar-input').value.trim()
            };
            
            if (editingCharacterId !== null) {
                characters[editingCharacterId] = character;
            } else {
                characters.push(character);
            }
            
            saveCharacters();
            updateCharacterList();
            closeCharacterModal();
        }

        function editCharacter(index) {
            openCharacterModal(index);
        }

        function deleteCharacter(index) {
            if (confirm('Are you sure you want to delete this character?')) {
                characters.splice(index, 1);
                saveCharacters();
                updateCharacterList();
            }
        }

        function shareCharacter() {
            const name = document.getElementById('character-name-input').value.trim();
            const prompt = document.getElementById('character-prompt-input').value.trim();
            
            if (!name || !prompt) {
                alert('Please complete the character before sharing.');
                return;
            }
            
            const character = {
                name: name,
                description: document.getElementById('character-description-input').value.trim(),
                prompt: prompt,
                firstMessage: document.getElementById('first-message-input').value.trim(),
                settings: {
                    temperature: parseFloat(document.getElementById('temperature-input').value),
                    maxTokens: parseInt(document.getElementById('max-tokens-input').value),
                    systemPrompt: document.getElementById('system-prompt-input').value.trim()
                },
                avatar: document.getElementById('character-avatar-input').value.trim()
            };
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?char=${encodeURIComponent(JSON.stringify(character))}`;
            
            if (navigator.share) {
                navigator.share({
                    title: `Character: ${name}`,
                    text: character.description || 'Check out this AI character!',
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('Character link copied to clipboard!');
                });
            }
        }

        // Tab management
        function switchTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Chat functionality
        function addMessage(role, content) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = content;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            chatHistory.push({ role, content });
        }

        function addTypingIndicator() {
            const chatMessages = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message typing';
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return typingDiv;
        }

        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message || !currentCharacter || isProcessing) return;
            
            // Add user message
            addMessage('user', message);
            messageInput.value = '';
            
            // Show typing indicator
            const typingIndicator = addTypingIndicator();
            isProcessing = true;
            
            try {
                const response = await callAI(currentCharacter, chatHistory);
                
                // Remove typing indicator
                typingIndicator.remove();
                
                // Add assistant response
                addMessage('assistant', response);
                
            } catch (error) {
                // Remove typing indicator
                typingIndicator.remove();
                
                // Add error message
                addMessage('assistant', `Sorry, I encountered an error: ${error.message}`);
                console.error('AI Error:', error);
            } finally {
                isProcessing = false;
            }
        }

        async function callAI(character, history) {
            const service = document.getElementById('service-select').value;
            const apiKey = document.getElementById('api-key').value.trim();
            
            if (!apiKey) {
                throw new Error('Please enter your API key in the sidebar');
            }
            
            const serviceConfig = AI_SERVICES[service];
            const model = serviceConfig.defaultModel;
            
            // Prepare messages for AI
            const messages = [];
            
            // Add system prompt if available
            if (character.settings.systemPrompt) {
                messages.push({
                    role: 'system',
                    content: character.settings.systemPrompt
                });
            }
            
            // Add character prompt
            messages.push({
                role: 'system',
                content: character.prompt
            });
            
            // Add chat history (excluding system messages)
            history.forEach(msg => {
                if (msg.role !== 'system') {
                    messages.push({
                        role: msg.role,
                        content: msg.content
                    });
                }
            });
            
            try {
                const response = await fetch(`${serviceConfig.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messages,
                        temperature: character.settings.temperature || 0.7,
                        max_tokens: character.settings.maxTokens || 500,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
                
            } catch (error) {
                // Fallback to mock response for demo purposes
                console.log('API call failed, using mock response:', error);
                return generateMockResponse(character, history);
            }
        }

        function generateMockResponse(character, history) {
            // Simple mock response generator for demo purposes
            const responses = [
                `I understand what you're saying. As ${character.name}, I'd like to explore this topic further.`,
                `That's an interesting perspective. Let me share my thoughts on that.`,
                `I appreciate you sharing that with me. As we continue our conversation, I'd like to understand more about your viewpoint.`,
                `Thank you for that message. It reminds me of something relevant to discuss.`,
                `I find that quite fascinating. Could you tell me more about your experience with this?`
            ];
            
            // Simulate typing delay
            return new Promise(resolve => {
                setTimeout(() => {
                    const lastMessage = history[history.length - 1];
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    
                    resolve(randomResponse);
                }, 1000 + Math.random() * 2000);
            });
        }

        async function testConnection() {
            const service = document.getElementById('service-select').value;
            const apiKey = document.getElementById('api-key').value.trim();
            const statusDiv = document.getElementById('connection-status');
            
            if (!apiKey) {
                statusDiv.innerHTML = '<div class="service-status disconnected">Please enter an API key</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="loading"></div> Testing connection...';
            
            try {
                // Test with a simple prompt
                const response = await fetch(`${AI_SERVICES[service].baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: AI_SERVICES[service].defaultModel,
                        messages: [{ role: 'user', content: 'Hello' }],
                        max_tokens: 10
                    })
                });
                
                if (response.ok) {
                    statusDiv.innerHTML = '<div class="service-status connected">✓ Connected successfully</div>';
                    saveAPIKeys();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="service-status disconnected">✗ Connection failed</div>';
                console.error('Connection test failed:', error);
            }
        }

        // API Key management
        function saveAPIKeys() {
            const apiKey = document.getElementById('api-key').value.trim();
            const service = document.getElementById('service-select').value;
            
            const keys = JSON.parse(localStorage.getItem('opencharacters-api-keys') || '{}');
            keys[service] = apiKey;
            localStorage.setItem('opencharacters-api-keys', JSON.stringify(keys));
        }

        function loadAPIKeys() {
            const service = document.getElementById('service-select').value;
            const keys = JSON.parse(localStorage.getItem('opencharacters-api-keys') || '{}');
            
            if (keys[service]) {
                document.getElementById('api-key').value = keys[service];
            }
        }

        // Service selector change handler
        document.getElementById('service-select').addEventListener('change', function() {
            loadAPIKeys();
            saveAPIKeys();
        });

        // API key change handler
        document.getElementById('api-key').addEventListener('input', saveAPIKeys);

        // Chat utility functions
        function clearChat() {
            if (confirm('Are you sure you want to clear the chat history?')) {
                chatHistory = [];
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = '';
                
                if (currentCharacter && currentCharacter.firstMessage) {
                    addMessage('assistant', currentCharacter.firstMessage);
                } else if (currentCharacter) {
                    addMessage('assistant', `Hello! I'm ${currentCharacter.name}. ${currentCharacter.description || 'How can I help you today?'}`);
                }
            }
        }

        function exportChat() {
            if (!currentCharacter) {
                alert('Please select a character first.');
                return;
            }
            
            const chatData = {
                character: currentCharacter,
                messages: chatHistory,
                exportedAt: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(chatData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `chat-${currentCharacter.name.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('character-modal');
            if (event.target === modal) {
                closeCharacterModal();
            }
        }
    </script>
</body>
</html>