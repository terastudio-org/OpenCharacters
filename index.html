<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCharacters - Character.AI Alternative</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .sidebar {
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: #333;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .controls {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-group {
            margin-bottom: 16px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .control-group input,
        .control-group select,
        .control-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-group input:focus,
        .control-group select:focus,
        .control-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .characters-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        .character-item {
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .character-item:hover,
        .character-item.active {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
            transform: translateX(5px);
        }

        .character-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .character-description {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Touch-friendly button states */
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #333;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            margin: 20px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chat-header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            color: #333;
            font-size: 20px;
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 70%;
            padding: 16px 20px;
            border-radius: 18px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: #667eea;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 6px;
        }

        .message.assistant {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 6px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .message.typing {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 6px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: typingAnimation 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .chat-input {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-container textarea {
            flex: 1;
            padding: 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            resize: none;
            font-size: 14px;
            font-family: inherit;
            max-height: 120px;
            min-height: 48px;
            transition: all 0.3s ease;
        }

        .input-container textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-btn {
            padding: 16px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .send-btn:hover:not(:disabled) {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h3 {
            color: #333;
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 4px;
        }

        .close-btn:hover {
            color: #333;
        }

        .tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid #e1e5e9;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .character-preview {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-top: 16px;
            border: 2px dashed #e1e5e9;
        }

        .character-preview h4 {
            color: #333;
            margin-bottom: 12px;
        }

        .character-preview p {
            color: #666;
            line-height: 1.6;
        }

        .share-link {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 8px 0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .service-status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .service-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .service-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        /* Advanced Features Styles */
        
        .advanced-section {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .advanced-section h3 {
            color: #333;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .analytics-dashboard {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .chart-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .chart-placeholder {
            color: #666;
            font-style: italic;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .usage-alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 12px;
        }

        .usage-alert.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .usage-alert.critical {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .usage-alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .plugin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .plugin-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .plugin-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .plugin-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .plugin-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .plugin-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .plugin-tag {
            background: #f0f2ff;
            color: #667eea;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .plugin-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .plugin-status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .plugin-status-indicator.active {
            background: #4CAF50;
        }

        .plugin-status-indicator.inactive {
            background: #ccc;
        }

        .team-members {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .team-member {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
        }

        .member-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 12px;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .member-role {
            color: #666;
            font-size: 12px;
        }

        .member-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .member-status.admin {
            background: #ffeaa7;
            color: #856404;
        }

        .member-status.member {
            background: #f0f2ff;
            color: #667eea;
        }

        .tab-advanced {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-advanced.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .advanced-modal {
            max-width: 900px;
            max-height: 90vh;
        }

        .modal-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 8px 16px;
            background: #f0f2ff;
            border: none;
            border-radius: 6px;
            color: #667eea;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-btn.active {
            background: #667eea;
            color: white;
        }

        .nav-btn:hover:not(.active) {
            background: #e1e5f9;
        }

        .rate-limit-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin: 16px 0;
        }

        .rate-limit-card {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 16px;
        }

        .rate-limit-service {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .rate-limit-usage {
            color: #666;
            font-size: 12px;
            margin-bottom: 12px;
        }

        .mini-chart {
            width: 100%;
            height: 40px;
            background: #f8f9fa;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .mini-chart-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .export-format-selector {
            display: flex;
            gap: 8px;
            margin: 16px 0;
        }

        .format-btn {
            padding: 8px 16px;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .format-btn.active {
            border-color: #667eea;
            background: #f0f2ff;
            color: #667eea;
        }

        /* Enhanced Mobile Optimizations */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                overflow-x: hidden;
            }
            
            .sidebar {
                position: fixed;
                top: 0;
                left: -100%;
                width: 280px;
                height: 100vh;
                z-index: 1001;
                transition: left 0.3s ease;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }
            
            .sidebar.open {
                left: 0;
            }
            
            .main-chat {
                margin: 0;
                margin-top: 60px;
                border-radius: 0;
                min-height: calc(100vh - 60px);
            }

            .header {
                padding: 16px;
            }

            .header h1 {
                font-size: 20px;
            }

            .controls {
                padding: 16px;
            }

            .characters-list {
                padding: 8px;
                max-height: calc(100vh - 300px);
            }

            .character-item {
                padding: 14px;
                margin-bottom: 10px;
            }

            .character-item:hover {
                transform: none;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-number {
                font-size: 24px;
            }

            .plugin-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .advanced-modal {
                margin: 10px;
                max-width: none;
                width: calc(100vw - 20px);
                max-height: calc(100vh - 20px);
            }

            .rate-limit-display {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .modal-content {
                padding: 20px;
                margin: 10px;
                max-width: none;
                width: calc(100vw - 20px);
            }

            .tabs {
                flex-wrap: wrap;
                gap: 4px;
            }

            .tab {
                padding: 8px 16px;
                font-size: 12px;
                min-width: 80px;
            }

            .modal-nav {
                flex-wrap: wrap;
                gap: 4px;
            }

            .nav-btn {
                padding: 6px 12px;
                font-size: 11px;
                min-width: 70px;
            }

            .chat-header {
                padding: 16px;
                flex-wrap: wrap;
                gap: 12px;
            }

            .chat-header h2 {
                font-size: 18px;
            }

            .chat-messages {
                padding: 16px;
                gap: 12px;
            }

            .message {
                max-width: 85%;
                padding: 12px 16px;
                font-size: 14px;
            }

            .chat-input {
                padding: 16px;
                position: sticky;
                bottom: 0;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
            }

            .input-container {
                gap: 8px;
            }

            .input-container textarea {
                padding: 12px;
                font-size: 16px;
                min-height: 44px;
            }

            .send-btn {
                padding: 12px 16px;
                min-width: 60px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 14px;
                min-height: 44px;
            }

            .btn-primary {
                width: 100%;
                margin-bottom: 8px;
            }

            .form-group {
                margin-bottom: 16px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 12px;
                font-size: 16px;
            }

            .character-preview {
                padding: 16px;
            }

            .service-status {
                padding: 6px 10px;
                font-size: 11px;
            }

            /* Mobile navigation overlay */
            .mobile-nav-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }

            .mobile-nav-overlay.active {
                opacity: 1;
                visibility: visible;
            }

            /* Mobile menu button */
            .mobile-menu-btn {
                display: block;
                position: fixed;
                top: 12px;
                left: 12px;
                z-index: 1002;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border: none;
                border-radius: 8px;
                padding: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                cursor: pointer;
            }

            .mobile-menu-btn svg {
                width: 20px;
                height: 20px;
                fill: #333;
            }

            /* Hide menu button on desktop */
            @media (min-width: 769px) {
                .mobile-menu-btn {
                    display: none;
                }
            }

            /* Character selection improvement */
            .character-item {
                min-height: 48px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            /* Touch-friendly buttons */
            .control-group button,
            .send-btn,
            .btn {
                min-height: 44px;
                min-width: 44px;
            }

            /* Improved message display */
            .message.assistant,
            .message.user {
                word-wrap: break-word;
                overflow-wrap: break-word;
                hyphens: auto;
            }

            /* Better modal scrolling */
            .modal-content {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Improved input focus for mobile */
            input:focus,
            textarea:focus,
            select:focus {
                font-size: 16px; /* Prevent zoom on iOS */
            }

            /* Better spacing for mobile */
            .tab-content {
                padding: 0 4px;
            }

            /* Mobile-specific chat enhancements */
            .chat-header button {
                min-height: 36px;
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        /* Extra small screens (phones in portrait) */
        @media (max-width: 480px) {
            .sidebar {
                width: 100vw;
            }

            .main-chat {
                margin-top: 56px;
            }

            .header h1 {
                font-size: 18px;
            }

            .header p {
                font-size: 12px;
            }

            .modal-content {
                padding: 16px;
                margin: 8px;
                width: calc(100vw - 16px);
            }

            .control-group label {
                font-size: 13px;
            }

            .character-item {
                padding: 12px;
            }

            .character-name {
                font-size: 14px;
            }

            .character-description {
                font-size: 11px;
            }

            .message {
                max-width: 90%;
                padding: 10px 12px;
                font-size: 13px;
            }

            .chat-header h2 {
                font-size: 16px;
            }

            .chat-input {
                padding: 12px;
            }

            .input-container textarea {
                padding: 10px;
                min-height: 40px;
            }
        }

        /* Landscape orientation improvements */
        @media (max-height: 500px) and (orientation: landscape) {
            .sidebar {
                max-height: 100vh;
                height: 100vh;
            }

            .characters-list {
                max-height: calc(100vh - 250px);
            }

            .main-chat {
                margin-top: 0;
            }

            .mobile-menu-btn {
                top: 8px;
                left: 8px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Navigation Overlay -->
    <div class="mobile-nav-overlay" id="mobile-nav-overlay" onclick="closeMobileNav()"></div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleMobileNav()" id="mobile-menu-btn">
        <svg viewBox="0 0 24 24">
            <path d="M3 12h18m-9-9v18"/>
        </svg>
    </button>

    <div class="sidebar" id="sidebar">
        <div class="header">
            <h1>OpenCharacters</h1>
            <p>Character.AI Alternative</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="service-select">AI Service:</label>
                <select id="service-select">
                    <option value="groq">Groq (Kimi)</option>
                    <option value="openai">OpenAI (GPT-4)</option>
                    <option value="anthropic">Anthropic (Claude)</option>
                    <option value="huggingface">Hugging Face</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="api-key">API Key:</label>
                <input type="password" id="api-key" placeholder="Enter your API key">
            </div>
            
            <button class="btn btn-primary" onclick="testConnection()">Test Connection</button>
            <div id="connection-status"></div>
        </div>
        
        <div class="characters-list" id="characters-list">
            <!-- Characters will be populated here -->
        </div>
        
        <div class="advanced-section">
            <h3>Quick Actions</h3>
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 8px;" onclick="openCharacterModal()">New Character</button>
            <button class="btn btn-secondary" style="width: 100%; margin-bottom: 8px;" onclick="openAnalytics()">Analytics</button>
            <button class="btn btn-secondary" style="width: 100%; margin-bottom: 8px;" onclick="openPluginManager()">Plugins</button>
            <button class="btn btn-secondary" style="width: 100%;" onclick="openTeamManager()">Team</button>
        </div>
    </div>

    <div class="main-chat">
        <div class="chat-header">
            <div>
                <h2 id="current-character-name">Select a character to start chatting</h2>
                <p id="current-character-description" style="color: #666; font-size: 14px;"></p>
            </div>
            <div>
                <button class="btn btn-secondary" onclick="clearChat()" style="margin-right: 10px;">Clear Chat</button>
                <button class="btn btn-secondary" onclick="exportChat()">Export</button>
            </div>
        </div>

        <div class="chat-messages" id="chat-messages">
            <div style="text-align: center; color: #666; margin-top: 50px;">
                <h3>Welcome to OpenCharacters!</h3>
                <p>Select a character from the sidebar or create a new one to start chatting.</p>
            </div>
        </div>

        <div class="chat-input">
            <div class="input-container">
                <textarea id="message-input" placeholder="Type your message..." rows="1" disabled></textarea>
                <button class="send-btn" id="send-btn" onclick="sendMessage()" disabled>
                    Send
                </button>
            </div>
        </div>
    </div>

    <!-- Character Creation/Editing Modal -->
    <div class="modal" id="character-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Create New Character</h3>
                <button class="close-btn" onclick="closeCharacterModal()">&times;</button>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('basic')">Basic Info</button>
                <button class="tab" onclick="switchTab('prompt')">Character Prompt</button>
                <button class="tab" onclick="switchTab('settings')">Settings</button>
            </div>
            
            <div class="tab-content active" id="basic-tab">
                <div class="form-group">
                    <label for="character-name-input">Character Name:</label>
                    <input type="text" id="character-name-input" placeholder="Enter character name">
                </div>
                
                <div class="form-group">
                    <label for="character-description-input">Description:</label>
                    <textarea id="character-description-input" placeholder="Brief description of the character"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="character-avatar-input">Avatar URL (optional):</label>
                    <input type="url" id="character-avatar-input" placeholder="https://example.com/avatar.jpg">
                </div>
            </div>
            
            <div class="tab-content" id="prompt-tab">
                <div class="form-group">
                    <label for="character-prompt-input">Character Prompt:</label>
                    <textarea id="character-prompt-input" placeholder="Define the character's personality, behavior, and speaking style..." rows="10"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="first-message-input">First Message (optional):</label>
                    <textarea id="first-message-input" placeholder="What should the character say when the conversation starts?"></textarea>
                </div>
            </div>
            
            <div class="tab-content" id="settings-tab">
                <div class="form-group">
                    <label for="temperature-input">Creativity (Temperature):</label>
                    <input type="range" id="temperature-input" min="0" max="2" step="0.1" value="0.7">
                    <span id="temperature-value">0.7</span>
                </div>
                
                <div class="form-group">
                    <label for="max-tokens-input">Max Response Length:</label>
                    <select id="max-tokens-input">
                        <option value="100">Short (100 tokens)</option>
                        <option value="300">Medium (300 tokens)</option>
                        <option value="500" selected>Long (500 tokens)</option>
                        <option value="1000">Very Long (1000 tokens)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="system-prompt-input">System Prompt (Advanced):</label>
                    <textarea id="system-prompt-input" placeholder="Additional system instructions for the AI..." rows="5"></textarea>
                </div>
            </div>
            
            <div class="character-preview">
                <h4>Character Preview:</h4>
                <p><strong>Name:</strong> <span id="preview-name">Not set</span></p>
                <p><strong>Description:</strong> <span id="preview-description">Not set</span></p>
                <p><strong>Prompt:</strong> <span id="preview-prompt">Not set</span></p>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-success" onclick="saveCharacter()">Save Character</button>
                <button class="btn btn-secondary" onclick="shareCharacter()">Share Character</button>
                <button class="btn btn-secondary" onclick="closeCharacterModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Global state management
        let characters = [];
        let currentCharacter = null;
        let chatHistory = [];
        let editingCharacterId = null;
        let isTyping = false;
        let isProcessing = false;

        // AI Service configurations
        const AI_SERVICES = {
            groq: {
                name: 'Groq',
                baseUrl: 'https://api.groq.com/openai/v1',
                models: {
                    'moonshotai/kimi-k2-instruct-0905': 'Kimi K2 Instruct',
                    'meta-llama/llama-3.1-8b-instant': 'Llama 3.1 8B',
                    'meta-llama/llama-3.1-70b-versatile': 'Llama 3.1 70B',
                    'mixtral-8x7b-32768': 'Mixtral 8x7B'
                },
                defaultModel: 'moonshotai/kimi-k2-instruct-0905'
            },
            openai: {
                name: 'OpenAI',
                baseUrl: 'https://api.openai.com/v1',
                models: {
                    'gpt-4': 'GPT-4',
                    'gpt-4-turbo': 'GPT-4 Turbo',
                    'gpt-3.5-turbo': 'GPT-3.5 Turbo'
                },
                defaultModel: 'gpt-3.5-turbo'
            },
            anthropic: {
                name: 'Anthropic',
                baseUrl: 'https://api.anthropic.com/v1',
                models: {
                    'claude-3-opus-20240229': 'Claude 3 Opus',
                    'claude-3-sonnet-20240229': 'Claude 3 Sonnet',
                    'claude-3-haiku-20240307': 'Claude 3 Haiku'
                },
                defaultModel: 'claude-3-haiku-20240307'
            },
            huggingface: {
                name: 'Hugging Face',
                baseUrl: 'https://api-inference.huggingface.co/models',
                models: {
                    'microsoft/DialoGPT-large': 'DialoGPT Large',
                    'microsoft/DialoGPT-medium': 'DialoGPT Medium',
                    'facebook/blenderbot-400M-distill': 'BlenderBot 400M'
                },
                defaultModel: 'microsoft/DialoGPT-medium'
            }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadCharacters();
            setupEventListeners();
            loadAPIKeys();
            updateCharacterList();
            
            // Check for shared character in URL
            const urlParams = new URLSearchParams(window.location.search);
            const sharedChar = urlParams.get('char');
            if (sharedChar) {
                try {
                    const character = JSON.parse(decodeURIComponent(sharedChar));
                    if (character && character.name && character.prompt) {
                        characters.push(character);
                        saveCharacters();
                        updateCharacterList();
                        selectCharacter(characters.length - 1);
                    }
                } catch (e) {
                    console.error('Error parsing shared character:', e);
                }
            }
        });

        // Event listeners setup
        function setupEventListeners() {
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            messageInput.addEventListener('input', function() {
                sendBtn.disabled = !this.value.trim() || !currentCharacter || isProcessing;
            });
            
            // Update temperature display
            document.getElementById('temperature-input').addEventListener('input', function() {
                document.getElementById('temperature-value').textContent = this.value;
                updateCharacterPreview();
            });
            
            // Update character preview on input changes
            ['character-name-input', 'character-description-input', 'character-prompt-input', 'first-message-input', 'system-prompt-input'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateCharacterPreview);
            });
        }

        // Character management functions
        function loadCharacters() {
            const saved = localStorage.getItem('opencharacters-characters');
            if (saved) {
                try {
                    characters = JSON.parse(saved);
                    // Add default characters if none exist
                    if (characters.length === 0) {
                        addDefaultCharacters();
                    }
                } catch (e) {
                    console.error('Error loading characters:', e);
                    characters = [];
                    addDefaultCharacters();
                }
            } else {
                addDefaultCharacters();
            }
        }

        function saveCharacters() {
            localStorage.setItem('opencharacters-characters', JSON.stringify(characters));
        }

        function addDefaultCharacters() {
            const defaultCharacters = [
                {
                    id: Date.now() + 1,
                    name: "Game Master",
                    description: "A wise and creative game master for roleplaying adventures",
                    prompt: "You are an experienced and creative game master. You create immersive roleplaying experiences with rich descriptions, engaging NPCs, and exciting plot twists. You're knowledgeable about various genres including fantasy, sci-fi, mystery, and horror. Always encourage player creativity and adapt the story based on their actions.",
                    firstMessage: "Welcome to our adventure! What kind of world would you like to explore today?",
                    settings: {
                        temperature: 0.8,
                        maxTokens: 500,
                        systemPrompt: "You are an expert game master creating engaging tabletop RPG experiences."
                    },
                    avatar: ""
                },
                {
                    id: Date.now() + 2,
                    name: "Therapist",
                    description: "A caring and professional therapist for emotional support",
                    prompt: "You are a compassionate and professional therapist. You listen carefully, ask thoughtful questions, and provide supportive guidance. You help people explore their feelings, develop coping strategies, and gain insights into their behavior. You maintain appropriate boundaries while being warm and understanding.",
                    firstMessage: "Hello, I'm here to listen and support you. How are you feeling today?",
                    settings: {
                        temperature: 0.6,
                        maxTokens: 300,
                        systemPrompt: "You are a licensed therapist providing emotional support and guidance."
                    },
                    avatar: ""
                },
                {
                    id: Date.now() + 3,
                    name: "Creative Writing Partner",
                    description: "An imaginative writing assistant for stories and creative projects",
                    prompt: "You are a talented creative writing partner who loves storytelling in all its forms. You help develop characters, plot outlines, dialogue, and world-building. You're knowledgeable about various genres and writing techniques. You provide constructive feedback and inspire creativity while respecting the author's vision.",
                    firstMessage: "I'm excited to help you create something amazing! What story or creative project would you like to work on?",
                    settings: {
                        temperature: 0.9,
                        maxTokens: 400,
                        systemPrompt: "You are a creative writing expert helping to develop compelling stories and narratives."
                    },
                    avatar: ""
                }
            ];
            
            characters = defaultCharacters;
            saveCharacters();
        }

        function updateCharacterList() {
            const charactersList = document.getElementById('characters-list');
            charactersList.innerHTML = '';
            
            characters.forEach((character, index) => {
                const characterItem = document.createElement('div');
                characterItem.className = 'character-item';
                if (currentCharacter && currentCharacter.id === character.id) {
                    characterItem.classList.add('active');
                }
                
                characterItem.innerHTML = `
                    <div class="character-name">${character.name}</div>
                    <div class="character-description">${character.description || 'No description'}</div>
                `;
                
                characterItem.onclick = () => selectCharacter(index);
                
                // Add context menu for editing
                characterItem.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    editCharacter(index);
                });
                
                charactersList.appendChild(characterItem);
            });
        }

        function selectCharacter(index) {
            currentCharacter = characters[index];
            chatHistory = [];
            
            document.getElementById('current-character-name').textContent = currentCharacter.name;
            document.getElementById('current-character-description').textContent = currentCharacter.description || '';
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
            
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            
            // Show first message if available
            if (currentCharacter.firstMessage) {
                addMessage('assistant', currentCharacter.firstMessage);
            } else {
                addMessage('assistant', `Hello! I'm ${currentCharacter.name}. ${currentCharacter.description || 'How can I help you today?'}`);
            }
            
            updateCharacterList();
        }

        function openCharacterModal(characterId = null) {
            editingCharacterId = characterId;
            const modal = document.getElementById('character-modal');
            const title = document.getElementById('modal-title');
            
            if (characterId !== null) {
                // Edit existing character
                title.textContent = 'Edit Character';
                const character = characters[characterId];
                populateCharacterForm(character);
            } else {
                // Create new character
                title.textContent = 'Create New Character';
                clearCharacterForm();
            }
            
            modal.style.display = 'block';
            updateCharacterPreview();
        }

        function closeCharacterModal() {
            document.getElementById('character-modal').style.display = 'none';
            editingCharacterId = null;
            clearCharacterForm();
        }

        function populateCharacterForm(character) {
            document.getElementById('character-name-input').value = character.name || '';
            document.getElementById('character-description-input').value = character.description || '';
            document.getElementById('character-avatar-input').value = character.avatar || '';
            document.getElementById('character-prompt-input').value = character.prompt || '';
            document.getElementById('first-message-input').value = character.firstMessage || '';
            document.getElementById('temperature-input').value = character.settings?.temperature || 0.7;
            document.getElementById('temperature-value').textContent = character.settings?.temperature || 0.7;
            document.getElementById('max-tokens-input').value = character.settings?.maxTokens || 500;
            document.getElementById('system-prompt-input').value = character.settings?.systemPrompt || '';
        }

        function clearCharacterForm() {
            document.getElementById('character-name-input').value = '';
            document.getElementById('character-description-input').value = '';
            document.getElementById('character-avatar-input').value = '';
            document.getElementById('character-prompt-input').value = '';
            document.getElementById('first-message-input').value = '';
            document.getElementById('temperature-input').value = 0.7;
            document.getElementById('temperature-value').textContent = 0.7;
            document.getElementById('max-tokens-input').value = 500;
            document.getElementById('system-prompt-input').value = '';
            updateCharacterPreview();
        }

        function updateCharacterPreview() {
            const name = document.getElementById('character-name-input').value || 'Not set';
            const description = document.getElementById('character-description-input').value || 'Not set';
            const prompt = document.getElementById('character-prompt-input').value || 'Not set';
            
            document.getElementById('preview-name').textContent = name;
            document.getElementById('preview-description').textContent = description;
            document.getElementById('preview-prompt').textContent = prompt.substring(0, 100) + (prompt.length > 100 ? '...' : '');
        }

        function saveCharacter() {
            const name = document.getElementById('character-name-input').value.trim();
            const prompt = document.getElementById('character-prompt-input').value.trim();
            
            if (!name) {
                alert('Please enter a character name.');
                return;
            }
            
            if (!prompt) {
                alert('Please enter a character prompt.');
                return;
            }
            
            const character = {
                id: editingCharacterId !== null ? characters[editingCharacterId].id : Date.now(),
                name: name,
                description: document.getElementById('character-description-input').value.trim(),
                prompt: prompt,
                firstMessage: document.getElementById('first-message-input').value.trim(),
                settings: {
                    temperature: parseFloat(document.getElementById('temperature-input').value),
                    maxTokens: parseInt(document.getElementById('max-tokens-input').value),
                    systemPrompt: document.getElementById('system-prompt-input').value.trim()
                },
                avatar: document.getElementById('character-avatar-input').value.trim()
            };
            
            if (editingCharacterId !== null) {
                characters[editingCharacterId] = character;
            } else {
                characters.push(character);
            }
            
            saveCharacters();
            updateCharacterList();
            closeCharacterModal();
        }

        function editCharacter(index) {
            openCharacterModal(index);
        }

        function deleteCharacter(index) {
            if (confirm('Are you sure you want to delete this character?')) {
                characters.splice(index, 1);
                saveCharacters();
                updateCharacterList();
            }
        }

        function shareCharacter() {
            const name = document.getElementById('character-name-input').value.trim();
            const prompt = document.getElementById('character-prompt-input').value.trim();
            
            if (!name || !prompt) {
                alert('Please complete the character before sharing.');
                return;
            }
            
            const character = {
                name: name,
                description: document.getElementById('character-description-input').value.trim(),
                prompt: prompt,
                firstMessage: document.getElementById('first-message-input').value.trim(),
                settings: {
                    temperature: parseFloat(document.getElementById('temperature-input').value),
                    maxTokens: parseInt(document.getElementById('max-tokens-input').value),
                    systemPrompt: document.getElementById('system-prompt-input').value.trim()
                },
                avatar: document.getElementById('character-avatar-input').value.trim()
            };
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?char=${encodeURIComponent(JSON.stringify(character))}`;
            
            if (navigator.share) {
                navigator.share({
                    title: `Character: ${name}`,
                    text: character.description || 'Check out this AI character!',
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('Character link copied to clipboard!');
                });
            }
        }

        // Tab management
        function switchTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Chat functionality
        function addMessage(role, content) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = content;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            chatHistory.push({ role, content });
        }

        function addTypingIndicator() {
            const chatMessages = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message typing';
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return typingDiv;
        }

        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message || !currentCharacter || isProcessing) return;
            
            // Add user message
            addMessage('user', message);
            messageInput.value = '';
            
            // Show typing indicator
            const typingIndicator = addTypingIndicator();
            isProcessing = true;
            
            try {
                const response = await callAI(currentCharacter, chatHistory);
                
                // Remove typing indicator
                typingIndicator.remove();
                
                // Add assistant response
                addMessage('assistant', response);
                
            } catch (error) {
                // Remove typing indicator
                typingIndicator.remove();
                
                // Add error message
                addMessage('assistant', `Sorry, I encountered an error: ${error.message}`);
                console.error('AI Error:', error);
            } finally {
                isProcessing = false;
            }
        }

        async function callAI(character, history) {
            const service = document.getElementById('service-select').value;
            const apiKey = document.getElementById('api-key').value.trim();
            
            if (!apiKey) {
                throw new Error('Please enter your API key in the sidebar');
            }
            
            const serviceConfig = AI_SERVICES[service];
            const model = serviceConfig.defaultModel;
            
            // Prepare messages for AI
            const messages = [];
            
            // Add system prompt if available
            if (character.settings.systemPrompt) {
                messages.push({
                    role: 'system',
                    content: character.settings.systemPrompt
                });
            }
            
            // Add character prompt
            messages.push({
                role: 'system',
                content: character.prompt
            });
            
            // Add chat history (excluding system messages)
            history.forEach(msg => {
                if (msg.role !== 'system') {
                    messages.push({
                        role: msg.role,
                        content: msg.content
                    });
                }
            });
            
            try {
                const response = await fetch(`${serviceConfig.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messages,
                        temperature: character.settings.temperature || 0.7,
                        max_tokens: character.settings.maxTokens || 500,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
                
            } catch (error) {
                // Fallback to mock response for demo purposes
                console.log('API call failed, using mock response:', error);
                return generateMockResponse(character, history);
            }
        }

        function generateMockResponse(character, history) {
            // Simple mock response generator for demo purposes
            const responses = [
                `I understand what you're saying. As ${character.name}, I'd like to explore this topic further.`,
                `That's an interesting perspective. Let me share my thoughts on that.`,
                `I appreciate you sharing that with me. As we continue our conversation, I'd like to understand more about your viewpoint.`,
                `Thank you for that message. It reminds me of something relevant to discuss.`,
                `I find that quite fascinating. Could you tell me more about your experience with this?`
            ];
            
            // Simulate typing delay
            return new Promise(resolve => {
                setTimeout(() => {
                    const lastMessage = history[history.length - 1];
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    
                    resolve(randomResponse);
                }, 1000 + Math.random() * 2000);
            });
        }

        async function testConnection() {
            const service = document.getElementById('service-select').value;
            const apiKey = document.getElementById('api-key').value.trim();
            const statusDiv = document.getElementById('connection-status');
            
            if (!apiKey) {
                statusDiv.innerHTML = '<div class="service-status disconnected">Please enter an API key</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="loading"></div> Testing connection...';
            
            try {
                // Test with a simple prompt
                const response = await fetch(`${AI_SERVICES[service].baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: AI_SERVICES[service].defaultModel,
                        messages: [{ role: 'user', content: 'Hello' }],
                        max_tokens: 10
                    })
                });
                
                if (response.ok) {
                    statusDiv.innerHTML = '<div class="service-status connected"> Connected successfully</div>';
                    saveAPIKeys();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="service-status disconnected"> Connection failed</div>';
                console.error('Connection test failed:', error);
            }
        }

        // API Key management
        function saveAPIKeys() {
            const apiKey = document.getElementById('api-key').value.trim();
            const service = document.getElementById('service-select').value;
            
            const keys = JSON.parse(localStorage.getItem('opencharacters-api-keys') || '{}');
            keys[service] = apiKey;
            localStorage.setItem('opencharacters-api-keys', JSON.stringify(keys));
        }

        function loadAPIKeys() {
            const service = document.getElementById('service-select').value;
            const keys = JSON.parse(localStorage.getItem('opencharacters-api-keys') || '{}');
            
            if (keys[service]) {
                document.getElementById('api-key').value = keys[service];
            }
        }

        // Service selector change handler
        document.getElementById('service-select').addEventListener('change', function() {
            loadAPIKeys();
            saveAPIKeys();
        });

        // API key change handler
        document.getElementById('api-key').addEventListener('input', saveAPIKeys);

        // Chat utility functions
        function clearChat() {
            if (confirm('Are you sure you want to clear the chat history?')) {
                chatHistory = [];
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = '';
                
                if (currentCharacter && currentCharacter.firstMessage) {
                    addMessage('assistant', currentCharacter.firstMessage);
                } else if (currentCharacter) {
                    addMessage('assistant', `Hello! I'm ${currentCharacter.name}. ${currentCharacter.description || 'How can I help you today?'}`);
                }
            }
        }

        function exportChat() {
            if (!currentCharacter) {
                alert('Please select a character first.');
                return;
            }
            
            const chatData = {
                character: currentCharacter,
                messages: chatHistory,
                exportedAt: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(chatData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `chat-${currentCharacter.name.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Advanced Features Modals
        function openAdvancedModal(modalId) {
            document.querySelectorAll('.advanced-modal').forEach(modal => {
                modal.style.display = 'none';
            });
            document.getElementById(modalId).style.display = 'block';
        }

        function openAnalytics() {
            const modal = document.createElement('div');
            modal.className = 'modal advanced-modal';
            modal.id = 'analytics-modal';
            modal.innerHTML = `
                <div class="modal-content advanced-modal">
                    <div class="modal-header">
                        <h3>Analytics Dashboard</h3>
                        <button class="close-btn" onclick="closeAdvancedModal('analytics-modal')">&times;</button>
                    </div>
                    <div class="modal-nav">
                        <button class="nav-btn active" onclick="showAnalyticsTab('overview')">Overview</button>
                        <button class="nav-btn" onclick="showAnalyticsTab('usage')">Usage</button>
                        <button class="nav-btn" onclick="showAnalyticsTab('performance')">Performance</button>
                        <button class="nav-btn" onclick="showAnalyticsTab('characters')">Characters</button>
                    </div>
                    <div class="analytics-dashboard">
                        <div id="analytics-overview" class="analytics-tab">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-number" id="total-conversations">${getUsageStats().totalConversations}</div>
                                    <div class="stat-label">Total Conversations</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="total-messages">${getUsageStats().totalMessages}</div>
                                    <div class="stat-label">Messages Sent</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="active-characters">${characters.length}</div>
                                    <div class="stat-label">Active Characters</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="total-characters">${characters.length}</div>
                                    <div class="stat-label">Total Characters</div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <div class="chart-placeholder">
                                    <h4>Usage Trends</h4>
                                    <p>Conversation activity over time</p>
                                </div>
                            </div>
                            <div class="chart-container">
                                <div class="chart-placeholder">
                                    <h4>AI Service Usage</h4>
                                    <p>Distribution of API calls by service</p>
                                </div>
                            </div>
                        </div>
                        <div id="analytics-usage" class="analytics-tab" style="display: none;">
                            <h4>API Usage Tracking</h4>
                            ${getRateLimitInfo()}
                            <div class="usage-alerts" id="usage-alerts">
                                ${getUsageAlerts()}
                            </div>
                        </div>
                        <div id="analytics-performance" class="analytics-tab" style="display: none;">
                            <h4>Performance Metrics</h4>
                            <div class="chart-container">
                                <div class="chart-placeholder">
                                    <h4>Response Times</h4>
                                    <p>Average response time by AI service</p>
                                </div>
                            </div>
                            <div class="chart-container">
                                <div class="chart-placeholder">
                                    <h4>Success Rate</h4>
                                    <p>API success rate over time</p>
                                </div>
                            </div>
                        </div>
                        <div id="analytics-characters" class="analytics-tab" style="display: none;">
                            <h4>Character Analytics</h4>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-number">${getMostUsedCharacter()}</div>
                                    <div class="stat-label">Most Used Character</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${getAverageSessionLength()}</div>
                                    <div class="stat-label">Avg Session Length</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${getCharacterEngagement()}</div>
                                    <div class="stat-label">Avg Engagement Score</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${getCreationDate()}</div>
                                    <div class="stat-label">Days Active</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
        }

        function openPluginManager() {
            const modal = document.createElement('div');
            modal.className = 'modal advanced-modal';
            modal.id = 'plugin-modal';
            modal.innerHTML = `
                <div class="modal-content advanced-modal">
                    <div class="modal-header">
                        <h3>Plugin Manager</h3>
                        <button class="close-btn" onclick="closeAdvancedModal('plugin-modal')">&times;</button>
                    </div>
                    <div class="modal-nav">
                        <button class="nav-btn active" onclick="showPluginTab('installed')">Installed</button>
                        <button class="nav-btn" onclick="showPluginTab('marketplace')">Marketplace</button>
                        <button class="nav-btn" onclick="showPluginTab('development')">Development</button>
                    </div>
                    <div class="plugin-content">
                        <div id="plugin-installed" class="plugin-tab">
                            <h4>Installed Plugins</h4>
                            <div class="plugin-grid" id="installed-plugins">
                                ${getInstalledPlugins()}
                            </div>
                        </div>
                        <div id="plugin-marketplace" class="plugin-tab" style="display: none;">
                            <h4>Plugin Marketplace</h4>
                            <div class="plugin-grid" id="marketplace-plugins">
                                ${getMarketplacePlugins()}
                            </div>
                        </div>
                        <div id="plugin-development" class="plugin-tab" style="display: none;">
                            <h4>Plugin Development</h4>
                            <p>Create custom plugins for OpenCharacters</p>
                            <button class="btn btn-primary" onclick="createNewPlugin()">Create Plugin</button>
                            <div style="margin-top: 20px;">
                                <h5>Plugin API Reference</h5>
                                <pre style="background: #f8f9fa; padding: 16px; border-radius: 8px; overflow-x: auto; font-size: 12px;">
// Plugin Structure
const myPlugin = {
    name: "My Plugin",
    version: "1.0.0",
    author: "Your Name",
    description: "Plugin description",
    initialize: function(app) {
        // Initialize plugin
    },
    destroy: function() {
        // Cleanup when plugin is disabled
    },
    hooks: {
        onMessage: function(message) {
            // Called when message is sent
        }
    }
};
                                </pre>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
        }

        function openTeamManager() {
            const modal = document.createElement('div');
            modal.className = 'modal advanced-modal';
            modal.id = 'team-modal';
            modal.innerHTML = `
                <div class="modal-content advanced-modal">
                    <div class="modal-header">
                        <h3>Team Management</h3>
                        <button class="close-btn" onclick="closeAdvancedModal('team-modal')">&times;</button>
                    </div>
                    <div class="modal-nav">
                        <button class="nav-btn active" onclick="showTeamTab('members')">Members</button>
                        <button class="nav-btn" onclick="showTeamTab('shared')">Shared Library</button>
                        <button class="nav-btn" onclick="showTeamTab('settings')">Settings</button>
                    </div>
                    <div class="team-content">
                        <div id="team-members" class="team-tab">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h4>Team Members</h4>
                                <button class="btn btn-primary" onclick="inviteMember()">Invite Member</button>
                            </div>
                            <div class="team-members" id="team-members-list">
                                ${getTeamMembers()}
                            </div>
                        </div>
                        <div id="team-shared" class="team-tab" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h4>Shared Character Library</h4>
                                <button class="btn btn-primary" onclick="shareCharacter()">Share Character</button>
                            </div>
                            <div class="characters-list" id="shared-characters">
                                ${getSharedCharacters()}
                            </div>
                        </div>
                        <div id="team-settings" class="team-tab" style="display: none;">
                            <h4>Team Settings</h4>
                            <div class="form-group">
                                <label>Team Name:</label>
                                <input type="text" id="team-name" placeholder="Your Team Name" value="OpenCharacters Team">
                            </div>
                            <div class="form-group">
                                <label>Default Permissions:</label>
                                <select id="default-permissions">
                                    <option value="read">Read Only</option>
                                    <option value="edit">Can Edit</option>
                                    <option value="admin">Administrator</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Collaboration Features:</label>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <label><input type="checkbox" checked> Real-time editing</label>
                                    <label><input type="checkbox" checked> Character sharing</label>
                                    <label><input type="checkbox" checked> Usage analytics</label>
                                    <label><input type="checkbox"> Voice calls</label>
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="saveTeamSettings()">Save Settings</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
        }

        function closeAdvancedModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                setTimeout(() => modal.remove(), 300);
            }
        }

        function showAnalyticsTab(tab) {
            document.querySelectorAll('.analytics-tab').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`analytics-${tab}`).style.display = 'block';
            event.target.classList.add('active');
        }

        function showPluginTab(tab) {
            document.querySelectorAll('.plugin-tab').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`plugin-${tab}`).style.display = 'block';
            event.target.classList.add('active');
        }

        function showTeamTab(tab) {
            document.querySelectorAll('.team-tab').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`team-${tab}`).style.display = 'block';
            event.target.classList.add('active');
        }

        // Analytics and Usage Tracking Functions
        function getUsageStats() {
            const stats = JSON.parse(localStorage.getItem('opencharacters-stats') || '{}');
            return {
                totalConversations: stats.totalConversations || 0,
                totalMessages: stats.totalMessages || 0,
                totalCharacters: characters.length
            };
        }

        function getRateLimitInfo() {
            const rateLimits = JSON.parse(localStorage.getItem('opencharacters-rate-limits') || '{}');
            const services = ['groq', 'openai', 'anthropic'];
            
            return services.map(service => {
                const serviceName = AI_SERVICES[service].name;
                const usage = rateLimits[service] || { used: 0, limit: 1000 };
                const percentage = Math.round((usage.used / usage.limit) * 100);
                
                return `
                    <div class="rate-limit-card">
                        <div class="rate-limit-service">${serviceName}</div>
                        <div class="rate-limit-usage">${usage.used} / ${usage.limit} requests</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                        <div class="mini-chart">
                            <div class="mini-chart-fill" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getUsageAlerts() {
            const alerts = JSON.parse(localStorage.getItem('opencharacters-alerts') || '[]');
            if (alerts.length === 0) {
                return '<div class="usage-alert success">No usage alerts at this time.</div>';
            }
            return alerts.map(alert => `
                <div class="usage-alert ${alert.type}">
                    ${alert.message}
                </div>
            `).join('');
        }

        function getMostUsedCharacter() {
            const characterUsage = JSON.parse(localStorage.getItem('opencharacters-character-usage') || '{}');
            const sorted = Object.entries(characterUsage).sort(([,a], [,b]) => b - a);
            return sorted[0] ? characters.find(c => c.id == sorted[0][0])?.name || 'None' : 'None';
        }

        function getAverageSessionLength() {
            const sessions = JSON.parse(localStorage.getItem('opencharacters-sessions') || '[]');
            if (sessions.length === 0) return '0';
            const total = sessions.reduce((sum, session) => sum + (session.duration || 0), 0);
            return Math.round(total / sessions.length);
        }

        function getCharacterEngagement() {
            return '8.5'; // Mock engagement score
        }

        function getCreationDate() {
            const created = localStorage.getItem('opencharacters-created');
            if (!created) return '0';
            const days = Math.floor((Date.now() - parseInt(created)) / (1000 * 60 * 60 * 24));
            return days;
        }

        // Plugin System Functions
        function getInstalledPlugins() {
            const plugins = JSON.parse(localStorage.getItem('opencharacters-plugins') || '[]');
            
            if (plugins.length === 0) {
                // Default plugins
                const defaultPlugins = [
                    {
                        name: 'Character Templates',
                        description: 'Pre-built character templates for quick creation',
                        tags: ['utility', 'character'],
                        status: 'active',
                        version: '1.0.0'
                    },
                    {
                        name: 'Export Manager',
                        description: 'Enhanced export options for characters and conversations',
                        tags: ['utility', 'export'],
                        status: 'active',
                        version: '1.0.0'
                    },
                    {
                        name: 'Analytics Plus',
                        description: 'Advanced analytics and reporting features',
                        tags: ['analytics', 'dashboard'],
                        status: 'inactive',
                        version: '1.0.0'
                    }
                ];
                localStorage.setItem('opencharacters-plugins', JSON.stringify(defaultPlugins));
                return getInstalledPlugins();
            }
            
            return plugins.map(plugin => `
                <div class="plugin-card">
                    <div class="plugin-title">${plugin.name}</div>
                    <div class="plugin-description">${plugin.description}</div>
                    <div class="plugin-tags">
                        ${plugin.tags.map(tag => `<span class="plugin-tag">${tag}</span>`).join('')}
                    </div>
                    <div class="plugin-status">
                        <div style="display: flex; align-items: center;">
                            <div class="plugin-status-indicator ${plugin.status}"></div>
                            <span style="font-size: 12px; color: #666;">${plugin.status}</span>
                        </div>
                        <span style="font-size: 11px; color: #999;">v${plugin.version}</span>
                    </div>
                </div>
            `).join('');
        }

        function getMarketplacePlugins() {
            const marketplacePlugins = [
                {
                    name: 'Voice Chat',
                    description: 'Add voice input and output to your conversations',
                    tags: ['voice', 'communication'],
                    status: 'active',
                    version: '1.2.0'
                },
                {
                    name: 'Image Generator',
                    description: 'Generate character avatars and images using AI',
                    tags: ['image', 'ai', 'generation'],
                    status: 'active',
                    version: '1.1.0'
                },
                {
                    name: 'Language Translator',
                    description: 'Translate conversations in real-time',
                    tags: ['translation', 'language'],
                    status: 'inactive',
                    version: '1.0.0'
                },
                {
                    name: 'Custom Themes',
                    description: 'Beautiful themes and UI customization',
                    tags: ['theme', 'ui', 'customization'],
                    status: 'active',
                    version: '2.0.0'
                },
                {
                    name: 'Export Formats',
                    description: 'Additional export formats (PDF, DOCX, TXT)',
                    tags: ['export', 'format'],
                    status: 'inactive',
                    version: '1.0.0'
                },
                {
                    name: 'API Monitor',
                    description: 'Monitor API usage and costs across services',
                    tags: ['analytics', 'monitoring'],
                    status: 'active',
                    version: '1.3.0'
                }
            ];
            
            return marketplacePlugins.map(plugin => `
                <div class="plugin-card">
                    <div class="plugin-title">${plugin.name}</div>
                    <div class="plugin-description">${plugin.description}</div>
                    <div class="plugin-tags">
                        ${plugin.tags.map(tag => `<span class="plugin-tag">${tag}</span>`).join('')}
                    </div>
                    <div class="plugin-status">
                        <div style="display: flex; align-items: center;">
                            <div class="plugin-status-indicator ${plugin.status}"></div>
                            <span style="font-size: 12px; color: #666;">${plugin.status}</span>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <span style="font-size: 11px; color: #999;">v${plugin.version}</span>
                            <button class="btn btn-primary" style="padding: 4px 8px; font-size: 11px;">Install</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function createNewPlugin() {
            alert('Plugin creation feature coming soon! This will open a development environment for creating custom plugins.');
        }

        // Team Collaboration Functions
        function getTeamMembers() {
            const members = JSON.parse(localStorage.getItem('opencharacters-team-members') || '[]');
            
            if (members.length === 0) {
                // Default team member
                const defaultMembers = [
                    {
                        name: 'You',
                        role: 'admin',
                        status: 'online',
                        avatar: 'YU'
                    }
                ];
                localStorage.setItem('opencharacters-team-members', JSON.stringify(defaultMembers));
                return getTeamMembers();
            }
            
            return members.map(member => `
                <div class="team-member">
                    <div class="member-avatar">${member.avatar}</div>
                    <div class="member-info">
                        <div class="member-name">${member.name}</div>
                        <div class="member-role">${member.status}</div>
                    </div>
                    <span class="member-status ${member.role}">${member.role}</span>
                </div>
            `).join('');
        }

        function getSharedCharacters() {
            if (characters.length === 0) {
                return '<div style="text-align: center; color: #666; padding: 20px;">No shared characters available</div>';
            }
            
            return characters.map(character => `
                <div class="character-item">
                    <div class="character-name">${character.name} (Shared)</div>
                    <div class="character-description">${character.description || 'No description'}</div>
                    <div style="margin-top: 8px; display: flex; gap: 8px;">
                        <button class="btn btn-primary" style="font-size: 12px; padding: 4px 8px;">Import</button>
                        <button class="btn btn-secondary" style="font-size: 12px; padding: 4px 8px;">View</button>
                    </div>
                </div>
            `).join('');
        }

        function inviteMember() {
            const email = prompt('Enter email address to invite:');
            if (email) {
                alert(`Invitation sent to ${email}! (Demo feature)`);
            }
        }

        function shareCharacter() {
            if (!currentCharacter) {
                alert('Please select a character first.');
                return;
            }
            const memberEmail = prompt('Enter team member email to share this character with:');
            if (memberEmail) {
                alert(`Character "${currentCharacter.name}" shared with ${memberEmail}! (Demo feature)`);
            }
        }

        function saveTeamSettings() {
            const teamName = document.getElementById('team-name').value;
            const defaultPermissions = document.getElementById('default-permissions').value;
            
            const settings = {
                teamName,
                defaultPermissions,
                updatedAt: Date.now()
            };
            
            localStorage.setItem('opencharacters-team-settings', JSON.stringify(settings));
            alert('Team settings saved successfully!');
        }

        // Enhanced API Usage Tracking
        function trackAPIUsage(service, tokens, cost) {
            const usage = JSON.parse(localStorage.getItem('opencharacters-api-usage') || '{}');
            const today = new Date().toISOString().split('T')[0];
            
            if (!usage[service]) {
                usage[service] = {};
            }
            if (!usage[service][today]) {
                usage[service][today] = { tokens: 0, cost: 0, calls: 0 };
            }
            
            usage[service][today].tokens += tokens;
            usage[service][today].cost += cost;
            usage[service][today].calls += 1;
            
            localStorage.setItem('opencharacters-api-usage', JSON.stringify(usage));
            
            // Update rate limits
            updateRateLimits(service, tokens);
        }

        function updateRateLimits(service, tokens) {
            const rateLimits = JSON.parse(localStorage.getItem('opencharacters-rate-limits') || '{}');
            const serviceLimits = rateLimits[service] || { used: 0, limit: 1000 };
            
            serviceLimits.used += 1;
            rateLimits[service] = serviceLimits;
            
            localStorage.setItem('opencharacters-rate-limits', JSON.stringify(rateLimits));
            
            // Check for alerts
            checkUsageAlerts(service, serviceLimits);
        }

        function checkUsageAlerts(service, limits) {
            const alerts = JSON.parse(localStorage.getItem('opencharacters-alerts') || []);
            const percentage = (limits.used / limits.limit) * 100;
            
            let alert = null;
            if (percentage >= 90) {
                alert = { type: 'critical', message: `Critical: ${AI_SERVICES[service].name} is at ${percentage}% of daily limit` };
            } else if (percentage >= 75) {
                alert = { type: 'warning', message: `Warning: ${AI_SERVICES[service].name} is at ${percentage}% of daily limit` };
            }
            
            if (alert && !alerts.some(a => a.message.includes(service))) {
                alerts.push(alert);
                localStorage.setItem('opencharacters-alerts', JSON.stringify(alerts));
            }
        }

        // Enhanced conversation tracking
        function startSession() {
            const session = {
                startTime: Date.now(),
                characterId: currentCharacter?.id,
                service: document.getElementById('service-select').value
            };
            localStorage.setItem('opencharacters-current-session', JSON.stringify(session));
        }

        function endSession() {
            const session = JSON.parse(localStorage.getItem('opencharacters-current-session') || '{}');
            if (session.startTime) {
                const duration = Math.floor((Date.now() - session.startTime) / 1000);
                const sessions = JSON.parse(localStorage.getItem('opencharacters-sessions') || '[]');
                sessions.push({ ...session, duration });
                localStorage.setItem('opencharacters-sessions', JSON.stringify(sessions));
            }
            localStorage.removeItem('opencharacters-current-session');
        }

        function trackConversation() {
            const stats = getUsageStats();
            stats.totalConversations += 1;
            localStorage.setItem('opencharacters-stats', JSON.stringify(stats));
        }

        function trackMessage() {
            const stats = getUsageStats();
            stats.totalMessages += 1;
            localStorage.setItem('opencharacters-stats', JSON.stringify(stats));
        }

        function trackCharacterUsage(characterId) {
            const usage = JSON.parse(localStorage.getItem('opencharacters-character-usage') || '{}');
            usage[characterId] = (usage[characterId] || 0) + 1;
            localStorage.setItem('opencharacters-character-usage', JSON.stringify(usage));
        }

        // Enhanced callAI function with tracking
        const originalCallAI = callAI;
        callAI = async function(character, history) {
            const service = document.getElementById('service-select').value;
            const startTime = Date.now();
            
            try {
                const response = await originalCallAI(character, history);
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                // Track successful API call
                trackAPIUsage(service, response.length, calculateCost(service, response.length));
                
                return response;
            } catch (error) {
                // Track failed API call
                trackAPIUsage(service, 0, 0);
                throw error;
            }
        };

        function calculateCost(service, tokens) {
            // Mock cost calculation
            const costs = {
                'groq': 0.0001,
                'openai': 0.0002,
                'anthropic': 0.00015
            };
            return (tokens / 1000) * (costs[service] || 0.0001);
        }

        // Initialize analytics on load
        document.addEventListener('DOMContentLoaded', function() {
            // Set creation date if not exists
            if (!localStorage.getItem('opencharacters-created')) {
                localStorage.setItem('opencharacters-created', Date.now().toString());
            }
            
            // Start initial session
            startSession();
            
            // Track initial stats
            trackConversation();
        });

        // End session before page unload
        window.addEventListener('beforeunload', function() {
            endSession();
        });

        // Enhanced character selection with tracking
        const originalSelectCharacter = selectCharacter;
        selectCharacter = function(index) {
            originalSelectCharacter(index);
            if (currentCharacter) {
                trackCharacterUsage(currentCharacter.id);
            }
        };

        // Enhanced message sending with tracking
        const originalSendMessage = sendMessage;
        sendMessage = async function() {
            await originalSendMessage();
            trackMessage();
            endSession();
            startSession();
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('character-modal');
            if (event.target === modal) {
                closeCharacterModal();
            }
            
            // Handle advanced modals
            const advancedModals = ['analytics-modal', 'plugin-modal', 'team-modal'];
            advancedModals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    closeAdvancedModal(modalId);
                }
            });

            // Close mobile nav when clicking outside
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-nav-overlay');
            if (event.target === overlay) {
                closeMobileNav();
            }
        }

        // Mobile Navigation Functions
        function toggleMobileNav() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-nav-overlay');
            const menuBtn = document.getElementById('mobile-menu-btn');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            
            // Update menu button icon
            const svg = menuBtn.querySelector('svg');
            if (sidebar.classList.contains('open')) {
                svg.innerHTML = '<path d="M6 18L18 6M6 6l12 12"/>'; // X icon
                document.body.style.overflow = 'hidden'; // Prevent background scroll
            } else {
                svg.innerHTML = '<path d="M3 12h18m-9-9v18"/>'; // Menu icon
                document.body.style.overflow = ''; // Restore scroll
            }
        }

        function closeMobileNav() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-nav-overlay');
            const menuBtn = document.getElementById('mobile-menu-btn');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            
            // Reset menu button icon
            const svg = menuBtn.querySelector('svg');
            svg.innerHTML = '<path d="M3 12h18m-9-9v18"/>';
            document.body.style.overflow = '';
        }

        // Close mobile nav when selecting a character
        const originalSelectCharacter = selectCharacter;
        selectCharacter = function(index) {
            originalSelectCharacter(index);
            // Close mobile nav if on mobile
            if (window.innerWidth <= 768) {
                closeMobileNav();
            }
        };

        // Close mobile nav when opening character modal
        const originalOpenCharacterModal = openCharacterModal;
        openCharacterModal = function(characterId = null) {
            originalOpenCharacterModal(characterId);
            // Close mobile nav if on mobile
            if (window.innerWidth <= 768) {
                closeMobileNav();
            }
        };

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                closeMobileNav();
            }
        });

        // Enhanced touch interactions for mobile
        function addTouchEnhancements() {
            // Add touch event listeners for better mobile interaction
            const touchElements = document.querySelectorAll('.character-item, .btn, .tab, .nav-btn');
            
            touchElements.forEach(element => {
                element.addEventListener('touchstart', function(e) {
                    this.style.transform = 'scale(0.98)';
                    this.style.transition = 'transform 0.1s ease';
                });
                
                element.addEventListener('touchend', function(e) {
                    this.style.transform = '';
                    this.style.transition = '';
                });
            });
        }

        // Initialize touch enhancements when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(addTouchEnhancements, 100);
        });
    </script>
</body>
</html>